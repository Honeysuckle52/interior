-- 1. Пользователи
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(254) NOT NULL,
    password VARCHAR(100) NOT NULL,
    user_type VARCHAR(10) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    bio TEXT NOT NULL,
    social_vk VARCHAR(200) NOT NULL,
    is_blocked TINYINT(1) NOT NULL,
    created_at DATETIME NOT NULL,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL
);

-- 2. Токены
CREATE TABLE email_verification_tokens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL UNIQUE,
    token VARCHAR(64) NOT NULL UNIQUE,
    expires_at DATETIME NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
) ;

CREATE TABLE password_reset_tokens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL UNIQUE,
    token VARCHAR(64) NOT NULL UNIQUE,
    expires_at DATETIME NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
) ;

-- 3. География
CREATE TABLE regions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    code VARCHAR(10) NOT NULL UNIQUE
) ;

CREATE TABLE cities (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    region_id INT NOT NULL,
    is_active TINYINT(1) NOT NULL,
    UNIQUE(name, region_id),
    FOREIGN KEY (region_id) REFERENCES regions(id)
) ;
-- 4. Справочники периодов и статусов
CREATE TABLE pricing_periods (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(100) NOT NULL,
    hours_count INT NOT NULL
) ;

CREATE TABLE booking_statuses (
    id INT AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL
);

CREATE TABLE transaction_statuses (
    id INT AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL
) ;

-- 5. Помещения
CREATE TABLE spaces (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    address VARCHAR(300) NOT NULL,
    city_id INT NOT NULL,
    category VARCHAR(50) NOT NULL,
    area_sqm DECIMAL(10,2) NOT NULL,
    max_capacity INT NOT NULL,
    description TEXT NOT NULL,
    views_count INT UNSIGNED NOT NULL,
    latitude DECIMAL(9,6) NULL,
    longitude DECIMAL(9,6) NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (city_id) REFERENCES cities(id)
);

-- 6. Изображения помещений (SpaceImage)
CREATE TABLE space_images (
    id INT AUTO_INCREMENT PRIMARY KEY,
    space_id INT NOT NULL,
    image VARCHAR(255) NOT NULL,
    alt_text VARCHAR(200) NOT NULL,
    FOREIGN KEY (space_id) REFERENCES spaces(id)
);

-- 7. Цены
CREATE TABLE space_prices (
    id INT AUTO_INCREMENT PRIMARY KEY,
    space_id INT NOT NULL,
    period_id INT NOT NULL,
    price FLOAT NOT NULL,
    is_active TINYINT(1) NOT NULL,
    periods INT NOT NULL,
    UNIQUE(space_id, period_id),
    FOREIGN KEY (space_id) REFERENCES spaces(id),
    FOREIGN KEY (period_id) REFERENCES pricing_periods(id)
) ;

-- 8. Бронирования
CREATE TABLE bookings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    space_id INT NOT NULL,
    tenant_id INT NOT NULL,
    period_id INT NOT NULL,
    status_id INT NOT NULL,
    start_datetime DATETIME NOT NULL,
    end_datetime DATETIME NOT NULL,
    periods_count INT NOT NULL,
    total_amount FLOAT NOT NULL,
    prepayment_paid TINYINT(1) NOT NULL,
    prepayment_amount FLOAT NULL,
    prepayment_paid_at DATETIME NULL,
    moderator_comment TEXT NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    FOREIGN KEY (space_id) REFERENCES spaces(id),
    FOREIGN KEY (tenant_id) REFERENCES users(id),
    FOREIGN KEY (period_id) REFERENCES pricing_periods(id),
    FOREIGN KEY (status_id) REFERENCES booking_statuses(id)
) ;

-- 9. Транзакции
CREATE TABLE transactions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    booking_id INT NOT NULL,
    status_id INT NOT NULL,
    amount FLOAT NOT NULL,
    payment_id VARCHAR(50) NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (booking_id) REFERENCES bookings(id),
    FOREIGN KEY (status_id) REFERENCES transaction_statuses(id)
) ;

-- 10. Отзывы
CREATE TABLE reviews (
    id INT AUTO_INCREMENT PRIMARY KEY,
    space_id INT NOT NULL,
    author_id INT NOT NULL,
    booking_id INT NULL,
    rating TINYINT,
    comment TEXT NOT NULL,
    is_approved TINYINT(1) NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (space_id) REFERENCES spaces(id),
    FOREIGN KEY (author_id) REFERENCES users(id),
    FOREIGN KEY (booking_id) REFERENCES bookings(id)
) ;

-- 11. Избранное
CREATE TABLE favorites (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    space_id INT NOT NULL,
    created_at DATETIME NOT NULL,
    UNIQUE(user_id, space_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (space_id) REFERENCES spaces(id)
);