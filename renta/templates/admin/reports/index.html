{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Отчеты и аналитика{% endblock %}

{% block content %}
<h1>Отчеты и аналитика</h1>

<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
    <!-- Статистика -->
    <div style="flex: 1; min-width: 200px; background: #417690; color: white; padding: 20px; border-radius: 8px;">
        <h3 style="margin: 0 0 10px 0;">Пользователи</h3>
        <p style="font-size: 32px; margin: 0; font-weight: bold;">{{ stats.total_users }}</p>
        <small>+{{ stats.new_users_month }} за месяц</small>
    </div>

    <div style="flex: 1; min-width: 200px; background: #79aec8; color: white; padding: 20px; border-radius: 8px;">
        <h3 style="margin: 0 0 10px 0;">Помещения</h3>
        <p style="font-size: 32px; margin: 0; font-weight: bold;">{{ stats.active_spaces }} / {{ stats.total_spaces }}</p>
        <small>Активных / Всего</small>
    </div>

    <div style="flex: 1; min-width: 200px; background: #609060; color: white; padding: 20px; border-radius: 8px;">
        <h3 style="margin: 0 0 10px 0;">Бронирования</h3>
        <p style="font-size: 32px; margin: 0; font-weight: bold;">{{ stats.bookings_month }}</p>
        <small>за последний месяц</small>
    </div>

    <div style="flex: 1; min-width: 200px; background: #c4a000; color: white; padding: 20px; border-radius: 8px;">
        <h3 style="margin: 0 0 10px 0;">Доход</h3>
        <p style="font-size: 32px; margin: 0; font-weight: bold;">{{ stats.revenue_month|floatformat:0 }} ₽</p>
        <small>за последний месяц</small>
    </div>
</div>

<!-- Быстрые ссылки -->
<div class="module" style="margin-bottom: 30px;">
    <h2>Отчеты</h2>
    <table>
        <tr>
            <th scope="row"><a href="{% url 'interior_admin:action_logs' %}">Журнал действий</a></th>
            <td>Полный лог всех действий пользователей на сайте</td>
        </tr>
        <tr>
            <th scope="row"><a href="{% url 'interior_admin:reports_dashboard' %}">Аналитический дашборд</a></th>
            <td>Графики и диаграммы по бронированиям и доходам</td>
        </tr>
    </table>
</div>

<!-- Экспорт отчетов -->
<div class="module" style="margin-bottom: 30px;">
    <h2>Экспорт отчетов</h2>
    <form method="get" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
        <div>
            <label for="date_from">С даты:</label><br>
            <input type="date" name="date_from" id="date_from">
        </div>
        <div>
            <label for="date_to">По дату:</label><br>
            <input type="date" name="date_to" id="date_to">
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'interior_admin:export_json' %}?type=actions" class="button" id="export_actions_json">
                Действия (JSON)
            </a>
            <a href="{% url 'interior_admin:export_csv' %}?type=actions" class="button" id="export_actions_csv">
                Действия (CSV)
            </a>
            <a href="{% url 'interior_admin:export_json' %}?type=bookings" class="button" id="export_bookings_json">
                Бронирования (JSON)
            </a>
            <a href="{% url 'interior_admin:export_csv' %}?type=bookings" class="button" id="export_bookings_csv">
                Бронирования (CSV)
            </a>
            <a href="{% url 'interior_admin:export_json' %}?type=revenue" class="button" id="export_revenue_json">
                Доходы (JSON)
            </a>
        </div>
    </form>
</div>

<!-- Последние действия -->
<div class="module">
    <h2>Последние действия</h2>
    <table>
        <thead>
            <tr>
                <th>Дата</th>
                <th>Пользователь</th>
                <th>Действие</th>
                <th>Модель</th>
                <th>Объект</th>
            </tr>
        </thead>
        <tbody>
            {% for log in recent_actions %}
            <tr>
                <td>{{ log.created_at|date:"d.m.Y H:i" }}</td>
                <td>
                    {% if log.user %}
                        <a href="{% url 'interior_admin:rental_customuser_change' log.user.pk %}">
                            {{ log.user.username }}
                        </a>
                    {% else %}
                        Аноним
                    {% endif %}
                </td>
                <td>
                    <span class="badge" style="
                        background:{% if log.action_type == 'create' %}#28a745{% elif log.action_type == 'update' %}#007bff{% elif log.action_type == 'delete' %}#dc3545{% elif log.action_type == 'login' %}#28a745{% else %}#6c757d{% endif %};
                        color: white;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                    ">
                        {{ log.get_action_type_display }}
                    </span>
                </td>
                <td>{{ log.model_name }}</td>
                <td>{{ log.object_repr|truncatechars:40 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5">Нет записей</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p><a href="{% url 'interior_admin:action_logs' %}">Показать все &rarr;</a></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');

    function updateLinks() {
        const params = new URLSearchParams();
        if (dateFrom.value) params.set('date_from', dateFrom.value);
        if (dateTo.value) params.set('date_to', dateTo.value);
        const queryStr = params.toString();

        document.querySelectorAll('a[id^="export_"]').forEach(link => {
            const baseUrl = link.href.split('?')[0];
            const type = link.id.includes('actions') ? 'actions' : 
                        link.id.includes('bookings') ? 'bookings' : 'revenue';
            link.href = baseUrl + '?type=' + type + (queryStr ? '&' + queryStr : '');
        });
    }

    dateFrom.addEventListener('change', updateLinks);
    dateTo.addEventListener('change', updateLinks);
});
</script>
{% endblock %}
