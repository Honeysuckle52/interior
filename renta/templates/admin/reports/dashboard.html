{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Аналитический дашборд{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --gold: #d4af37;
        --gold-light: #e5c666;
        --gold-dark: #b8941f;
        --bg-dark: #1a1a1a;
        --bg-darker: #0a0a0a;
        --bg-card: #171717;
        --text-primary: #fafafa;
        --text-muted: #a1a1aa;
        --border-color: #27272a;
        --success: #22c55e;
        --danger: #ef4444;
        --info: #3b82f6;
        --warning: #f59e0b;
    }

    body.light-mode {
        --bg-dark: #ffffff;
        --bg-darker: #f8f9fa;
        --bg-card: #ffffff;
        --text-primary: #1a1a1a;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--gold);
        flex-wrap: wrap;
        gap: 15px;
    }

    .dashboard-header h1 {
        color: var(--gold);
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .back-link {
        color: var(--gold);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .back-link:hover {
        gap: 12px;
        color: var(--gold-light);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: linear-gradient(145deg, var(--bg-dark), var(--bg-darker));
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .chart-card:hover {
        border-color: var(--gold);
        box-shadow: 0 8px 30px rgba(212, 175, 55, 0.15);
    }

    .chart-card h2 {
        color: var(--text-primary);
        font-size: 1.1rem;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .chart-card h2 i {
        color: var(--gold);
        font-size: 1rem;
    }

    .chart-wrapper {
        position: relative;
        height: 250px;
    }

    .bottom-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
    }

    .data-card {
        background: linear-gradient(145deg, var(--bg-dark), var(--bg-darker));
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .data-card h2 {
        color: var(--text-primary);
        font-size: 1.1rem;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .data-card h2 i {
        color: var(--gold);
    }

    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .data-table th {
        background: linear-gradient(135deg, var(--gold), var(--gold-dark));
        color: #000;
        padding: 12px 14px;
        text-align: left;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table th:first-child {
        border-radius: 8px 0 0 0;
    }

    .data-table th:last-child {
        border-radius: 0 8px 0 0;
    }

    .data-table td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .data-table tr:hover td {
        background: rgba(212, 175, 55, 0.05);
    }

    .data-table a {
        color: var(--gold);
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .data-table a:hover {
        color: var(--gold-light);
        text-decoration: underline;
    }

    .revenue-cell {
        color: var(--success);
        font-weight: 600;
    }

    .no-data {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }

    .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .chart-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-top: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .bottom-section {
            grid-template-columns: 1fr;
        }

        .chart-wrapper {
            height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-chart-bar"></i> Аналитический дашборд</h1>
        <a href="{% url 'interior_admin:reports' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Назад к отчетам
        </a>
    </div>

    <div class="charts-grid">
        <!-- График бронирований -->
        <div class="chart-card">
            <h2><i class="fas fa-calendar-check"></i> Бронирования за 30 дней</h2>
            <div class="chart-wrapper">
                <canvas id="bookingsChart"></canvas>
            </div>
        </div>

        <!-- График доходов -->
        <div class="chart-card">
            <h2><i class="fas fa-ruble-sign"></i> Доходы за 30 дней</h2>
            <div class="chart-wrapper">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <!-- Топ помещений -->
        <div class="data-card">
            <h2><i class="fas fa-trophy"></i> Топ-5 помещений</h2>
            {% if top_spaces %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Помещение</th>
                        <th>Бронирований</th>
                        <th>Доход</th>
                    </tr>
                </thead>
                <tbody>
                    {% for space in top_spaces %}
                    <tr>
                        <td>
                            <a href="{% url 'interior_admin:rental_space_change' space.pk %}">
                                {{ space.title|truncatechars:25 }}
                            </a>
                        </td>
                        <td>{{ space.bookings_count }}</td>
                        <td class="revenue-cell">{{ space.revenue|floatformat:0|default:"0" }} ₽</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-data">
                <i class="fas fa-inbox"></i>
                <p>Нет данных</p>
            </div>
            {% endif %}
        </div>

        <!-- Распределение по статусам -->
        <div class="chart-card">
            <h2><i class="fas fa-chart-pie"></i> Бронирования по статусам</h2>
            <div class="chart-wrapper">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Настройки для графиков
    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    };

    // Цвета
    const goldColor = '#d4af37';
    const goldLight = '#e5c666';
    const goldDark = '#b8941f';
    const textMuted = '#a1a1aa';
    const borderColor = '#27272a';

    // Данные
    const bookingsData = {{ bookings_by_day|safe }};
    const revenueData = {{ revenue_by_day|safe }};
    const statusData = {{ status_distribution|safe }};

    // График бронирований (Line Chart)
    const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
    const bookingsGradient = bookingsCtx.createLinearGradient(0, 0, 0, 250);
    bookingsGradient.addColorStop(0, 'rgba(212, 175, 55, 0.3)');
    bookingsGradient.addColorStop(1, 'rgba(212, 175, 55, 0)');

    new Chart(bookingsCtx, {
        type: 'line',
        data: {
            labels: bookingsData.map(d => d.date),
            datasets: [{
                label: 'Бронирований',
                data: bookingsData.map(d => d.count),
                borderColor: goldColor,
                backgroundColor: bookingsGradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: goldColor,
                pointBorderColor: '#1a1a1a',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            ...chartDefaults,
            scales: {
                x: {
                    grid: {
                        color: borderColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textMuted,
                        maxRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: borderColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textMuted,
                        stepSize: 1
                    }
                }
            }
        }
    });

    // График доходов (Bar Chart)
    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: {
            labels: revenueData.map(d => d.date),
            datasets: [{
                label: 'Доход (₽)',
                data: revenueData.map(d => d.amount),
                backgroundColor: function(context) {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                    gradient.addColorStop(0, goldColor);
                    gradient.addColorStop(1, goldDark);
                    return gradient;
                },
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            ...chartDefaults,
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: textMuted,
                        maxRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: borderColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textMuted,
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' ₽';
                        }
                    }
                }
            }
        }
    });

    // Круговая диаграмма статусов (Doughnut Chart)
    if (statusData && statusData.length > 0) {
        const statusColors = {
            'warning': '#f59e0b',
            'success': '#22c55e',
            'info': '#3b82f6',
            'danger': '#ef4444',
            'secondary': '#6b7280',
            'primary': goldColor
        };

        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
                labels: statusData.map(d => d.status__name),
                datasets: [{
                    data: statusData.map(d => d.count),
                    backgroundColor: statusData.map(d => statusColors[d.status__color] || '#6b7280'),
                    borderColor: '#1a1a1a',
                    borderWidth: 3,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: textMuted,
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('statusChart').parentElement.innerHTML = `
            <div class="no-data">
                <i class="fas fa-chart-pie"></i>
                <p>Нет данных о статусах</p>
            </div>
        `;
    }
});
</script>
{% endblock %}
