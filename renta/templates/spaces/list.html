{% extends 'base.html' %}
{% load static %}

{% block title %}Все помещения | INTERIOR{% endblock %}

{% block content %}
<div class="container" style="padding-top: 100px;">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 fw-bold mb-2">Все помещения</h1>
            <p class="text-muted">Найдите идеальное пространство для вашего бизнеса</p>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="filter-panel-modern mb-4">
        <form method="get" id="filterForm">
            <div class="filter-search-box mb-4">
                <i class="fas fa-search filter-search-icon"></i>
                <input type="text" name="search" class="filter-search-input"
                       placeholder="Поиск по названию или описанию..."
                       value="{{ search_query }}">
            </div>

            <div class="filter-fields-grid">
                <div class="filter-field-group">
                    <label class="filter-label">Город</label>
                    <select name="city" class="filter-select-styled">
                        <option value="">Все города</option>
                        {% for city in cities %}
                        <option value="{{ city.id }}" {% if city.id|stringformat:"i" == selected_city %}selected{% endif %}>{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field-group">
                    <label class="filter-label">Площадь, м²</label>
                    <div class="filter-range-inputs">
                        <input type="number" name="min_area" class="filter-input-styled" placeholder="от" value="{{ min_area }}" min="0">
                        <span class="filter-range-sep">—</span>
                        <input type="number" name="max_area" class="filter-input-styled" placeholder="до" value="{{ max_area }}" min="0">
                    </div>
                </div>

                <div class="filter-field-group">
                    <label class="filter-label">Вместимость</label>
                    <input type="number" name="min_capacity" class="filter-input-styled" placeholder="от человек" value="{{ min_capacity }}" min="1">
                </div>

                <div class="filter-field-group">
                    <label class="filter-label">Цена, ₽</label>
                    <div class="filter-range-inputs">
                        <input type="number" name="min_price" class="filter-input-styled" placeholder="от" value="{{ min_price }}" min="0">
                        <span class="filter-range-sep">—</span>
                        <input type="number" name="max_price" class="filter-input-styled" placeholder="до" value="{{ max_price }}" min="0">
                    </div>
                </div>
            </div>

            <div class="filter-categories-wrapper mt-4">
                <label class="filter-label mb-3">Категории</label>
                <div class="filter-category-chips">
                    {% for category in categories %}
                    <label class="filter-chip {% if category.id|stringformat:'i' in selected_categories %}active{% endif %}">
                        <input type="checkbox" name="category" value="{{ category.id }}"
                               {% if category.id|stringformat:'i' in selected_categories %}checked{% endif %}>
                        <span>{{ category.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-buttons mt-4">
                <button type="submit" class="btn btn-gold">Найти</button>
                <a href="{% url 'spaces_list' %}" class="btn btn-outline-secondary">Сбросить</a>
            </div>
        </form>
    </div>

    {% if total_count %}
    <p class="text-muted mb-3">Найдено: <strong class="gold-text">{{ total_count }}</strong></p>
    {% endif %}

    <!-- Карточки помещений -->
    <div class="row g-4">
        {% for space in spaces %}
        <div class="col-lg-4 col-md-6">
            <div class="space-card h-100">
                <div class="space-card-image-wrapper">
                    {% with space.get_main_image as image %}
                    {% if image and image.image %}
                    <img src="{{ image.image.url }}" class="space-image" alt="{{ space.title }}" loading="lazy">
                    {% else %}
                    <img src="https://via.placeholder.com/400x250/171717/d4af37?text=INTERIOR" class="space-image" alt="{{ space.title }}" loading="lazy">
                    {% endif %}
                    {% endwith %}

                    <span class="space-badge-overlay">{{ space.category.name }}</span>

                    {% if user.is_authenticated %}
                    <button class="space-favorite-btn {% if space.id in favorite_ids %}active{% endif %}"
                            data-space-id="{{ space.id }}" type="button">
                        <i class="{% if space.id in favorite_ids %}fas{% else %}far{% endif %} fa-heart"></i>
                    </button>
                    {% endif %}

                    <span class="space-city-overlay">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ space.city.name }}
                    </span>
                </div>

                <div class="space-card-body">
                    <h5 class="space-card-title">{{ space.title }}</h5>
                    <div class="space-card-meta">
                        <span>{{ space.area_sqm }} м²</span>
                        <span>до {{ space.max_capacity }} чел.</span>
                    </div>
                    <p class="space-card-desc">{{ space.description|truncatewords:18 }}</p>
                    <div class="space-card-footer">
                        <div class="space-card-price">
                            {% with space.prices.first as price %}
                            {% if price %}
                            <span class="price-amount">от {{ price.price|floatformat:0 }} ₽</span>
                            <span class="price-type">{{ price.period.description }}</span>
                            {% else %}
                            <span class="price-amount">Цена по запросу</span>
                            {% endif %}
                            {% endwith %}
                        </div>
                        <a href="{% url 'space_detail' space.id %}" class="btn btn-gold btn-sm">Подробнее</a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <i class="fas fa-search fa-3x mb-3 text-muted"></i>
            <h4>Помещения не найдены</h4>
            <p class="text-muted">Попробуйте изменить параметры поиска</p>
            <a href="{% url 'spaces_list' %}" class="btn btn-gold mt-3">Сбросить фильтры</a>
        </div>
        {% endfor %}
    </div>

    <!-- Пагинация -->
    {% if spaces.has_other_pages %}
    <nav class="mt-5">
        <ul class="pagination justify-content-center">
            {% if spaces.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ spaces.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_city %}&city={{ selected_city }}{% endif %}{% for cat in selected_categories %}&category={{ cat }}{% endfor %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in spaces.paginator.page_range %}
            {% if spaces.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > spaces.number|add:'-3' and num < spaces.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_city %}&city={{ selected_city }}{% endif %}{% for cat in selected_categories %}&category={{ cat }}{% endfor %}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if spaces.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ spaces.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_city %}&city={{ selected_city }}{% endif %}{% for cat in selected_categories %}&category={{ cat }}{% endfor %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// Переключение активного состояния чипов категорий
document.querySelectorAll('.filter-chip input').forEach(cb => {
    cb.addEventListener('change', function() {
        this.closest('.filter-chip').classList.toggle('active', this.checked);
    });
});
</script>
{% endblock %}
