{% extends 'base.html' %}
{% load static %}

{% block title %}Бронирование | INTERIOR{% endblock %}

{% block content %}
<div class="container" style="padding-top: 100px;">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb breadcrumb-styled py-2 px-3 rounded">
            <li class="breadcrumb-item">
                <a href="{% url 'home' %}" class="breadcrumb-link fw-medium">
                    <i class="fas fa-home me-1"></i>Главная
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'space_detail' space.id %}" class="breadcrumb-link fw-medium">{{ space.title|truncatechars:25 }}</a>
            </li>
            <li class="breadcrumb-item active fw-bold" aria-current="page">Бронирование</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="booking-form-card">
                <h2 class="fw-bold mb-4"></i>Бронирование</h2>

                <form method="post" id="bookingForm">
                    {% csrf_token %}

                    <div class="row g-4 mb-4">
                        <!-- Кастомный календарь вместо стандартного input[type=date] -->
                        <div class="col-md-6">
                            <label class="form-label">Дата начала</label>
                            <div class="custom-datepicker-wrapper">
                                <div class="input-with-icon">
                                    </i>
                                    <button type="button" class="custom-datepicker-trigger" id="datepickerTrigger">
                                        <span id="selectedDateText">Выберите дату</span>
                                    </button>
                                    <input type="hidden" name="start_date" id="id_start_date" required>
                                </div>

                                <!-- Кастомный календарь -->
                                <div class="custom-calendar" id="customCalendar">
                                    <div class="calendar-header">
                                        <button type="button" class="calendar-nav-btn" id="prevMonth">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="calendar-title" id="calendarTitle">Декабрь 2025</span>
                                        <button type="button" class="calendar-nav-btn" id="nextMonth">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="calendar-weekdays">
                                        <div class="calendar-weekday">Пн</div>
                                        <div class="calendar-weekday">Вт</div>
                                        <div class="calendar-weekday">Ср</div>
                                        <div class="calendar-weekday">Чт</div>
                                        <div class="calendar-weekday">Пт</div>
                                        <div class="calendar-weekday">Сб</div>
                                        <div class="calendar-weekday">Вс</div>
                                    </div>
                                    <div class="calendar-days" id="calendarDays">
                                        <!-- Дни генерируются JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6" id="timeInputWrapper">
                            <label class="form-label">Время начала</label>
                            <div class="input-with-icon">
                                </i>
                                {{ form.start_time }}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Период аренды</label>
                            <div class="input-with-icon">
                                </i>
                                {{ form.period }}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Количество периодов</label>
                            <div class="input-with-icon">
                                </i>
                                {{ form.periods_count }}
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Комментарий</label>
                            {{ form.comment }}
                        </div>
                    </div>

                    <button type="submit" class="btn btn-gold btn-lg">
                        <i class="fas fa-check me-2"></i>Забронировать
                    </button>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="booking-sidebar sticky-top" style="top: 100px;">
                <h5 class="fw-bold mb-3">{{ space.title }}</h5>
                <p class="text-muted small mb-3">
                    </i>{{ space.city.name }}, {{ space.address }}
                </p>
                <hr style="border-color: var(--border-color);">
                <h6 class="fw-bold mb-3">Цены:</h6>
                {% for price in prices %}
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">{{ price.period.description }}</span>
                    <span class="gold-text fw-bold">{{ price.price|floatformat:0 }} ₽</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const trigger = document.getElementById('datepickerTrigger');
    const calendar = document.getElementById('customCalendar');
    const calendarDays = document.getElementById('calendarDays');
    const calendarTitle = document.getElementById('calendarTitle');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const hiddenInput = document.getElementById('id_start_date');
    const selectedDateText = document.getElementById('selectedDateText');
    const periodSelect = document.querySelector('select[name="period"]');
    const timeWrapper = document.getElementById('timeInputWrapper');

    const monthNames = [
        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];

    let currentDate = new Date();
    let selectedDate = null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const minDate = new Date(today);
    const maxDate = new Date(today);
    maxDate.setFullYear(maxDate.getFullYear() + 2);

    // Открытие/закрытие календаря
    trigger.addEventListener('click', function(e) {
        e.preventDefault();
        calendar.classList.toggle('active');
    });

    // Закрытие при клике вне календаря
    document.addEventListener('click', function(e) {
        if (!calendar.contains(e.target) && e.target !== trigger && !trigger.contains(e.target)) {
            calendar.classList.remove('active');
        }
    });

    // Навигация по месяцам
    prevMonthBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        calendarTitle.textContent = `${monthNames[month]} ${year}`;

        // Первый день месяца
        const firstDay = new Date(year, month, 1);
        // Последний день месяца
        const lastDay = new Date(year, month + 1, 0);

        // День недели первого дня (0 = воскресенье, нужно преобразовать для понедельника)
        let startDay = firstDay.getDay();
        startDay = startDay === 0 ? 6 : startDay - 1;

        calendarDays.innerHTML = '';

        // Дни предыдущего месяца
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = startDay - 1; i >= 0; i--) {
            const dayEl = createDayElement(prevMonthLastDay - i, true, true);
            calendarDays.appendChild(dayEl);
        }

        // Дни текущего месяца
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            const isDisabled = date < minDate || date > maxDate;
            const isToday = date.getTime() === today.getTime();
            const isSelected = selectedDate && date.getTime() === selectedDate.getTime();

            const dayEl = createDayElement(day, false, isDisabled, isToday, isSelected, date);
            calendarDays.appendChild(dayEl);
        }

        // Дни следующего месяца
        const totalCells = calendarDays.children.length;
        const remainingCells = 42 - totalCells; // 6 рядов по 7 дней
        for (let i = 1; i <= remainingCells; i++) {
            const dayEl = createDayElement(i, true, true);
            calendarDays.appendChild(dayEl);
        }
    }

    function createDayElement(day, isOtherMonth, isDisabled, isToday = false, isSelected = false, date = null) {
        const dayEl = document.createElement('button');
        dayEl.type = 'button';
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;

        if (isOtherMonth) dayEl.classList.add('other-month');
        if (isDisabled) dayEl.classList.add('disabled');
        if (isToday) dayEl.classList.add('today');
        if (isSelected) dayEl.classList.add('selected');

        if (!isDisabled && !isOtherMonth && date) {
            dayEl.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                selectDate(date);
            });
        }

        return dayEl;
    }

    function selectDate(date) {
        selectedDate = date;

        // Форматируем для скрытого поля (YYYY-MM-DD)
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        hiddenInput.value = `${year}-${month}-${day}`;

        // Форматируем для отображения
        selectedDateText.textContent = `${day}.${month}.${year}`;

        // Закрываем календарь
        calendar.classList.remove('active');

        // Обновляем отображение
        renderCalendar();
    }

    // Инициализация с текущей датой
    selectDate(today);
    renderCalendar();

    // Логика скрытия времени для недельной/месячной аренды
    function updateTimeVisibility() {
        if (!periodSelect || !timeWrapper) return;

        const selectedOption = periodSelect.options[periodSelect.selectedIndex];
        const periodText = selectedOption ? selectedOption.textContent.toLowerCase() : '';

        if (periodText.includes('недел') || periodText.includes('месяц')) {
            timeWrapper.style.display = 'none';
        } else {
            timeWrapper.style.display = 'block';
        }
    }

    if (periodSelect) {
        periodSelect.addEventListener('change', updateTimeVisibility);
        updateTimeVisibility();
    }
});
</script>
{% endblock %}